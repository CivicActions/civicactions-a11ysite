services:
  apache:
    image: tugboatqa/httpd:2.4
    default: true
    checkout: true

    commands:
      init:
        # Point Apache at the Eleventy build output
        - ln -snf "${TUGBOAT_ROOT}/_site" "${DOCROOT}"

        # Enable mod_rewrite and allow .htaccess overrides in the docroot.
        # (The official httpd image uses /usr/local/apache2/conf/httpd.conf)
        - |
          bash -lc '
            set -euo pipefail
            CONF=/usr/local/apache2/conf/httpd.conf

            # Enable rewrite module if commented out
            sed -i "s/^#LoadModule rewrite_module modules\\/mod_rewrite.so/LoadModule rewrite_module modules\\/mod_rewrite.so/" "$CONF"

            # Ensure AllowOverride is enabled for the standard docroot directory block.
            # This is intentionally narrow, not global.
            sed -i "s/AllowOverride None/AllowOverride All/" "$CONF"
          '

      update:
        # Deterministic installs are better in CI
        - bash -lc 'cd "${TUGBOAT_ROOT}" && npm ci'

      build:
        - bash -lc 'cd "${TUGBOAT_ROOT}" && npm run build'
        - bash -lc 'printf "%s\n" \
          "RewriteEngine On" \
          "RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.html -f" \
          "RewriteRule !\\.\\w{2,4}$ %{REQUEST_URI}.html [L]" \
          > "${TUGBOAT_ROOT}/_site/.htaccess"'
