services:
  apache:
    image: tugboatqa/httpd:2.4
    default: true
    checkout: true

    commands:
      init:
        # Install Node.js + npm (required for npm ci / npm run build)
        - |
          bash -lc '
            set -euo pipefail

            if command -v apt-get >/dev/null 2>&1; then
              apt-get update
              apt-get install -y --no-install-recommends ca-certificates curl gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y --no-install-recommends nodejs
            elif command -v apk >/dev/null 2>&1; then
              apk add --no-cache nodejs npm
            else
              echo "No supported package manager found (apt-get/apk). Cannot install Node." >&2
              exit 1
            fi

            node -v
            npm -v
          '

        # Point Apache at the Eleventy build output
        - ln -snf "${TUGBOAT_ROOT}/_site" "${DOCROOT}"

        # Enable mod_rewrite and allow .htaccess overrides in the docroot.
        - |
          bash -lc '
            set -euo pipefail
            CONF=/usr/local/apache2/conf/httpd.conf

            sed -i "s/^#LoadModule rewrite_module modules\\/mod_rewrite.so/LoadModule rewrite_module modules\\/mod_rewrite.so/" "$CONF" || true
            sed -i "s/AllowOverride None/AllowOverride All/" "$CONF" || true
          '

      update:
        - bash -lc 'cd "${TUGBOAT_ROOT}" && npm ci'

      build:
        - bash -lc 'cd "${TUGBOAT_ROOT}" && npm run build'
        - bash -lc 'printf "%s\n" \
          "RewriteEngine On" \
          "RewriteCond %{DOCUMENT_ROOT}%{REQUEST_URI}.html -f" \
          "RewriteRule !\\.\\w{2,4}$ %{REQUEST_URI}.html [L]" \
          > "${TUGBOAT_ROOT}/_site/.htaccess"'
